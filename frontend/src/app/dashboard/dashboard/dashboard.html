<!-- Splash Screen -->
<div class="splash-screen" *ngIf="showSplash">
  <svg class="r-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <!-- Letra R estilizada -->
    <path class="r-path" d="M30,20 L30,80 M30,20 L60,20 C75,20 75,50 60,50 L30,50 M60,50 L80,80" fill="none"
      stroke="#3f51b5" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" />
  </svg>
</div>

<!-- Contenido del Dashboard -->
<div class="dashboard-container" *ngIf="!showSplash">
  <header class="dashboard-header">
    <h1>Reportes Automatizados</h1>
    <div class="user-controls">
      <span class="username">Hola, {{ username }}</span>

      <button mat-icon-button (click)="openReportesModal()" matTooltip="Reportes Avanzados">
        <mat-icon>assessment</mat-icon>
      </button>

      <!-- Theme Toggle Switch -->
      <div class="theme-toggle-container">
        <mat-icon class="theme-icon sun-icon" [class.active]="!isDarkTheme">light_mode</mat-icon>
        <mat-slide-toggle [checked]="isDarkTheme" (change)="toggleTheme()" color="primary" class="theme-toggle"
          matTooltip="Cambiar tema" matTooltipPosition="below">
        </mat-slide-toggle>
        <mat-icon class="theme-icon moon-icon" [class.active]="isDarkTheme">dark_mode</mat-icon>
      </div>

      <button mat-raised-button color="warn" (click)="logout()">
        <mat-icon>logout</mat-icon> Cerrar Sesión
      </button>
    </div>
  </header>

  <mat-tab-group animationDuration="0ms" (selectedIndexChange)="onTabChange($event)">
    <!-- Pestaña Resumen -->
    <mat-tab label="Resumen">
      <div class="tab-content">
        <div *ngIf="loading" class="loading-spinner">
          <mat-spinner></mat-spinner>
        </div>

        <div *ngIf="!loading && summary" class="summary-cards">
          <mat-card class="summary-card sales-card">
            <mat-card-header>
              <mat-card-title>Total Ventas</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <p class="amount">{{ summary.total_ventas | currency }}</p>
            </mat-card-content>
          </mat-card>

          <mat-card class="summary-card purchases-card">
            <mat-card-header>
              <mat-card-title>Total Compras</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <p class="amount">{{ summary.total_compras | currency }}</p>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-tab>

    <!-- Pestaña Operaciones -->
    <mat-tab label="Operaciones">
      <div class="tab-content">
        <app-operations-form></app-operations-form>
      </div>
    </mat-tab>

    <!-- Pestaña Carga de Archivos -->
    <mat-tab label="Carga de Archivos">
      <div class="tab-content">
        <app-file-upload></app-file-upload>
      </div>
    </mat-tab>

    <!-- Pestaña Historial -->
    <mat-tab label="Historial">
      <div class="tab-content">
        <h3>Historial de Transacciones</h3>
        <p>Tabla con las últimas ventas y compras.</p>
        <!-- TODO: Tabla de historial -->
      </div>
    </mat-tab>

    <!-- Pestaña Conflictos (Solo Gerentes) -->
    <mat-tab label="Conflictos" *ngIf="isGerente">
      <div class="tab-content">
        <h3>Conflictos de Conciliación</h3>

        <table mat-table [dataSource]="conflictos" class="mat-elevation-z8" *ngIf="conflictos.length > 0">
          <!-- Tipo Column -->
          <ng-container matColumnDef="tipo">
            <th mat-header-cell *matHeaderCellDef> Tipo </th>
            <td mat-cell *matCellDef="let element"> {{element.tipo_modelo}} </td>
          </ng-container>

          <!-- ID Borrado Column -->
          <ng-container matColumnDef="id_borrado">
            <th mat-header-cell *matHeaderCellDef> ID Borrado </th>
            <td mat-cell *matCellDef="let element"> {{element.id_borrado}} </td>
          </ng-container>

          <!-- ID Existente Column -->
          <ng-container matColumnDef="id_existente">
            <th mat-header-cell *matHeaderCellDef> ID Existente </th>
            <td mat-cell *matCellDef="let element"> {{element.id_existente}} </td>
          </ng-container>

          <!-- Estado Column -->
          <ng-container matColumnDef="estado">
            <th mat-header-cell *matHeaderCellDef> Estado </th>
            <td mat-cell *matCellDef="let element"> {{element.estado}} </td>
          </ng-container>

          <!-- Fecha Column -->
          <ng-container matColumnDef="fecha">
            <th mat-header-cell *matHeaderCellDef> Fecha Detección </th>
            <td mat-cell *matCellDef="let element"> {{element.fecha_deteccion | date:'short'}} </td>
          </ng-container>

          <!-- Acciones Column -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef> Acciones </th>
            <td mat-cell *matCellDef="let element">
              <button mat-raised-button color="primary" (click)="resolverConflicto(element)"
                [disabled]="element.estado !== 'PENDIENTE'">
                Resolver
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumnsConflictos"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumnsConflictos;"></tr>
        </table>

        <p *ngIf="conflictos.length === 0">No hay conflictos pendientes.</p>
      </div>
    </mat-tab>

    <!-- Pestaña Papelera (Solo Gerentes) -->
    <mat-tab label="Papelera" *ngIf="isGerente">
      <div class="tab-content">
        <div class="papelera-header">
          <h3>Papelera de Reciclaje</h3>

          <!-- Selector de Categoría -->
          <div class="category-selector">
            <button mat-raised-button [color]="papeleraCategoria === 'productos' ? 'primary' : ''"
              (click)="onPapeleraCategoriaChange('productos')">
              <mat-icon>inventory_2</mat-icon>
              Productos
            </button>
            <button mat-raised-button [color]="papeleraCategoria === 'ventas' ? 'primary' : ''"
              (click)="onPapeleraCategoriaChange('ventas')">
              <mat-icon>point_of_sale</mat-icon>
              Ventas
            </button>
            <button mat-raised-button [color]="papeleraCategoria === 'compras' ? 'primary' : ''"
              (click)="onPapeleraCategoriaChange('compras')">
              <mat-icon>shopping_cart</mat-icon>
              Compras
            </button>
            <button mat-raised-button [color]="papeleraCategoria === 'clientes' ? 'primary' : ''"
              (click)="onPapeleraCategoriaChange('clientes')">
              <mat-icon>people</mat-icon>
              Clientes
            </button>
            <button mat-raised-button [color]="papeleraCategoria === 'proveedores' ? 'primary' : ''"
              (click)="onPapeleraCategoriaChange('proveedores')">
              <mat-icon>local_shipping</mat-icon>
              Proveedores
            </button>
          </div>
        </div>

        <!-- Barra de Búsqueda y Filtros -->
        <div class="search-filter-container">
          <!-- Búsqueda General por ID -->
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Buscar por ID o Nombre</mat-label>
            <input matInput [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()" placeholder="Ej: 123">
            <mat-icon matPrefix>search</mat-icon>
            <button mat-icon-button matSuffix *ngIf="searchTerm" (click)="searchTerm=''; onSearchChange()">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>

          <!-- Botón para expandir filtros -->
          <button mat-raised-button (click)="toggleFilters()" class="filter-toggle-btn">
            <mat-icon>{{showFilters ? 'expand_less' : 'expand_more'}}</mat-icon>
            Filtros Avanzados
          </button>
        </div>

        <!-- Panel de Filtros Expandible -->
        <div class="filters-panel" *ngIf="showFilters" [@detailExpand]="showFilters ? 'expanded' : 'collapsed'">
          <!-- Filtros por Fecha (todas las categorías) -->
          <div class="date-filters">
            <h4>
              <mat-icon>date_range</mat-icon>
              Filtrar por Rango de Fechas
              <span class="filter-hint">
                ({{papeleraCategoria === 'ventas' || papeleraCategoria === 'compras' ? 'Fecha de transacción' : 'Fecha
                de creación'}})
              </span>
            </h4>

            <mat-form-field appearance="outline" class="date-range-field">
              <mat-label>Seleccionar Rango</mat-label>
              <mat-date-range-input [formGroup]="dateRangeForm" [rangePicker]="picker">
                <input matStartDate formControlName="start" placeholder="Fecha inicio"
                  (dateChange)="onDateFilterChange()">
                <input matEndDate formControlName="end" placeholder="Fecha fin" (dateChange)="onDateFilterChange()">
              </mat-date-range-input>
              <mat-hint>DD/MM/AAAA – DD/MM/AAAA</mat-hint>
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-date-range-picker #picker></mat-date-range-picker>
            </mat-form-field>

            <button mat-raised-button color="warn" (click)="clearFilters()" class="clear-btn">
              <mat-icon>clear</mat-icon>
              Limpiar Filtros
            </button>
          </div>
        </div>

        <!-- Loading Spinner -->
        <div *ngIf="papeleraLoading" class="loading-container">
          <mat-spinner></mat-spinner>
        </div>

        <!-- Tabla Expandible -->
        <div *ngIf="!papeleraLoading" class="papelera-table-container">
          <table mat-table [dataSource]="papeleraItemsFiltered" multiTemplateDataRows class="papelera-table">

            <!-- Expand Column -->
            <ng-container matColumnDef="expand">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let element">
                <button mat-icon-button (click)="togglePapeleraItem(element); $event.stopPropagation()">
                  <mat-icon>{{expandedPapeleraItem?.id === element.id ? 'expand_less' : 'expand_more'}}</mat-icon>
                </button>
              </td>
            </ng-container>

            <!-- ID Column -->
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef>ID</th>
              <td mat-cell *matCellDef="let element">
                <span class="id-badge">#{{element.id}}</span>
              </td>
            </ng-container>

            <!-- Nombre Column -->
            <ng-container matColumnDef="nombre">
              <th mat-header-cell *matHeaderCellDef>Nombre</th>
              <td mat-cell *matCellDef="let element">{{element.nombre}}</td>
            </ng-container>

            <!-- Tipo Column (solo para productos) -->
            <ng-container matColumnDef="tipo">
              <th mat-header-cell *matHeaderCellDef>Tipo</th>
              <td mat-cell *matCellDef="let element">
                <span class="tipo-badge">{{papeleraCategoria}}</span>
              </td>
            </ng-container>

            <!-- Deleted At Column -->
            <ng-container matColumnDef="deleted_at">
              <th mat-header-cell *matHeaderCellDef>Fecha Eliminación</th>
              <td mat-cell *matCellDef="let element">{{element.deleted_at | date:'short'}}</td>
            </ng-container>

            <!-- Acciones Column -->
            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let element">
                <button mat-raised-button color="primary" (click)="restaurarItem(element); $event.stopPropagation()">
                  <mat-icon>restore</mat-icon>
                  Restaurar
                </button>
              </td>
            </ng-container>

            <!-- Expanded Content (Card) -->
            <ng-container matColumnDef="expandedDetail">
              <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumnsPapelera.length">
                <div class="element-detail"
                  [@detailExpand]="element.id === expandedPapeleraItem?.id ? 'expanded' : 'collapsed'">
                  <div class="detail-card">
                    <h4>Detalles Completos</h4>

                    <!-- Productos -->
                    <div *ngIf="papeleraCategoria === 'productos'" class="detail-grid">
                      <div class="detail-item">
                        <span class="detail-label">ID:</span>
                        <span class="detail-value">{{element.id}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Nombre:</span>
                        <span class="detail-value">{{element.nombre}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Descripción:</span>
                        <span class="detail-value">{{element.descripcion || 'N/A'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Stock:</span>
                        <span class="detail-value">{{element.stock}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Precio Compra:</span>
                        <span class="detail-value">{{element.precio_compra_actual | currency}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Proveedor:</span>
                        <span class="detail-value">{{element.proveedor_nombre || 'N/A'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Creado por:</span>
                        <span class="detail-value">{{element.created_by_username || 'N/A'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Fecha creación:</span>
                        <span class="detail-value">{{element.created_at | date:'medium'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Eliminado:</span>
                        <span class="detail-value">{{element.deleted_at | date:'medium'}}</span>
                      </div>
                    </div>

                    <!-- Ventas -->
                    <div *ngIf="papeleraCategoria === 'ventas'" class="detail-grid">
                      <div class="detail-item">
                        <span class="detail-label">ID:</span>
                        <span class="detail-value">{{element.id}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Producto:</span>
                        <span class="detail-value">{{element.producto_nombre || 'N/A'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Cliente:</span>
                        <span class="detail-value">{{element.cliente_nombre || 'N/A'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Cantidad:</span>
                        <span class="detail-value">{{element.cantidad}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Precio Venta:</span>
                        <span class="detail-value">{{element.precio_venta | currency}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Total:</span>
                        <span class="detail-value">{{element.total | currency}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Fecha:</span>
                        <span class="detail-value">{{element.fecha | date:'medium'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Eliminado:</span>
                        <span class="detail-value">{{element.deleted_at | date:'medium'}}</span>
                      </div>
                    </div>

                    <!-- Compras -->
                    <div *ngIf="papeleraCategoria === 'compras'" class="detail-grid">
                      <div class="detail-item">
                        <span class="detail-label">ID:</span>
                        <span class="detail-value">{{element.id}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Producto:</span>
                        <span class="detail-value">{{element.producto_nombre || 'N/A'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Proveedor:</span>
                        <span class="detail-value">{{element.proveedor_nombre || 'N/A'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Cantidad:</span>
                        <span class="detail-value">{{element.cantidad}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Precio Unitario:</span>
                        <span class="detail-value">{{element.precio_compra_unitario | currency}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Total:</span>
                        <span class="detail-value">{{element.total | currency}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Fecha:</span>
                        <span class="detail-value">{{element.fecha | date:'medium'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Eliminado:</span>
                        <span class="detail-value">{{element.deleted_at | date:'medium'}}</span>
                      </div>
                    </div>

                    <!-- Clientes -->
                    <div *ngIf="papeleraCategoria === 'clientes'" class="detail-grid">
                      <div class="detail-item">
                        <span class="detail-label">ID:</span>
                        <span class="detail-value">{{element.id}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Nombre:</span>
                        <span class="detail-value">{{element.nombre}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Total Gastado:</span>
                        <span class="detail-value">{{element.total_gastado | currency}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Creado por:</span>
                        <span class="detail-value">{{element.created_by_username || 'N/A'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Fecha creación:</span>
                        <span class="detail-value">{{element.created_at | date:'medium'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Eliminado:</span>
                        <span class="detail-value">{{element.deleted_at | date:'medium'}}</span>
                      </div>
                    </div>

                    <!-- Proveedores -->
                    <div *ngIf="papeleraCategoria === 'proveedores'" class="detail-grid">
                      <div class="detail-item">
                        <span class="detail-label">ID:</span>
                        <span class="detail-value">{{element.id}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Nombre:</span>
                        <span class="detail-value">{{element.nombre}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Total Comprado:</span>
                        <span class="detail-value">{{element.total_comprado | currency}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Creado por:</span>
                        <span class="detail-value">{{element.created_by_username || 'N/A'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Fecha creación:</span>
                        <span class="detail-value">{{element.created_at | date:'medium'}}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Eliminado:</span>
                        <span class="detail-value">{{element.deleted_at | date:'medium'}}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Table Rows -->
            <tr mat-header-row *matHeaderRowDef="displayedColumnsPapelera"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumnsPapelera;" class="element-row"
              [class.expanded-row]="expandedPapeleraItem?.id === row.id" (click)="togglePapeleraItem(row)">
            </tr>
            <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
          </table>

          <p *ngIf="papeleraItemsFiltered.length === 0 && !papeleraLoading" class="empty-message">
            <mat-icon>{{searchTerm || dateRangeForm.get('start')?.value || dateRangeForm.get('end')?.value ?
              'search_off' : 'delete_outline'}}</mat-icon>
            {{searchTerm || dateRangeForm.get('start')?.value || dateRangeForm.get('end')?.value ? 'No se encontraron
            resultados con los filtros aplicados.'
            : 'No hay elementos en la papelera de ' + papeleraCategoria + '.'}}
          </p>
        </div>
      </div>
    </mat-tab>


  </mat-tab-group>
</div>