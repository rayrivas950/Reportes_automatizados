<div class="modal-container">
    <div class="modal-header">
        <h2>Reportes Avanzados</h2>
        <div class="header-actions">
            <button mat-icon-button (click)="toggleFilters()" matTooltip="Alternar filtros">
                <mat-icon>{{ isFiltersCollapsed ? 'filter_list' : 'filter_list_off' }}</mat-icon>
            </button>
            <button mat-icon-button (click)="close()">
                <mat-icon>close</mat-icon>
            </button>
        </div>
    </div>

    <div class="filters-panel" [class.collapsed]="isFiltersCollapsed">
        <form [formGroup]="filtrosForm">
            <div class="filter-row">
                <mat-form-field appearance="outline">
                    <mat-label>Rango de Fechas</mat-label>
                    <mat-date-range-input [rangePicker]="picker">
                        <input matStartDate formControlName="fecha_inicio" placeholder="Inicio">
                        <input matEndDate formControlName="fecha_fin" placeholder="Fin">
                    </mat-date-range-input>
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-date-range-picker #picker></mat-date-range-picker>
                </mat-form-field>

                <mat-form-field appearance="outline" class="chip-list-field">
                    <mat-label>Clientes</mat-label>
                    <mat-chip-grid #chipGridClientes>
                        <mat-chip-row *ngFor="let cliente of selectedClientes" (removed)="removeCliente(cliente)">
                            {{cliente.nombre}}
                            <button matChipRemove>
                                <mat-icon>cancel</mat-icon>
                            </button>
                        </mat-chip-row>
                    </mat-chip-grid>
                    <input placeholder="Buscar cliente..." #clienteInput formControlName="cliente_input"
                        [matChipInputFor]="chipGridClientes" [matAutocomplete]="autoClientes">
                    <mat-autocomplete #autoClientes="matAutocomplete" (optionSelected)="selectedCliente($event)">
                        <mat-option *ngFor="let cliente of filteredClientes$ | async" [value]="cliente">
                            {{cliente.nombre}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>

                <mat-form-field appearance="outline" class="chip-list-field">
                    <mat-label>Proveedores</mat-label>
                    <mat-chip-grid #chipGridProveedores>
                        <mat-chip-row *ngFor="let proveedor of selectedProveedores"
                            (removed)="removeProveedor(proveedor)">
                            {{proveedor.nombre}}
                            <button matChipRemove>
                                <mat-icon>cancel</mat-icon>
                            </button>
                        </mat-chip-row>
                    </mat-chip-grid>
                    <input placeholder="Buscar proveedor..." #proveedorInput formControlName="proveedor_input"
                        [matChipInputFor]="chipGridProveedores" [matAutocomplete]="autoProveedores">
                    <mat-autocomplete #autoProveedores="matAutocomplete" (optionSelected)="selectedProveedor($event)">
                        <mat-option *ngFor="let proveedor of filteredProveedores$ | async" [value]="proveedor">
                            {{proveedor.nombre}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>

                <mat-form-field appearance="outline" class="chip-list-field">
                    <mat-label>Productos</mat-label>
                    <mat-chip-grid #chipGridProductos>
                        <mat-chip-row *ngFor="let producto of selectedProductos" (removed)="removeProducto(producto)">
                            {{producto.nombre}}
                            <button matChipRemove>
                                <mat-icon>cancel</mat-icon>
                            </button>
                        </mat-chip-row>
                    </mat-chip-grid>
                    <input placeholder="Buscar producto..." #productoInput formControlName="producto_input"
                        [matChipInputFor]="chipGridProductos" [matAutocomplete]="autoProductos">
                    <mat-autocomplete #autoProductos="matAutocomplete" (optionSelected)="selectedProducto($event)">
                        <mat-option *ngFor="let producto of filteredProductos$ | async" [value]="producto">
                            {{producto.nombre}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>
            </div>
        </form>
    </div>

    <div class="summary-cards" *ngIf="balance">
        <div class="card ventas">
            <span class="label">Total Ventas</span>
            <span class="value">{{ balance.total_ventas | currency }}</span>
            <span class="count">{{ balance.cantidad_ventas }} transacciones</span>
        </div>
        <div class="card compras">
            <span class="label">Total Compras</span>
            <span class="value">{{ balance.total_compras | currency }}</span>
            <span class="count">{{ balance.cantidad_compras }} transacciones</span>
        </div>
        <div class="card utilidad" [class.positive]="balance.utilidad_bruta >= 0"
            [class.negative]="balance.utilidad_bruta < 0">
            <span class="label">Utilidad Bruta</span>
            <span class="value">{{ balance.utilidad_bruta | currency }}</span>
        </div>
    </div>

    <div class="table-container">
        <div class="loading-shade" *ngIf="isLoading">
            <mat-spinner></mat-spinner>
        </div>

        <table mat-table [dataSource]="transacciones" class="report-table">
            <!-- Fecha Column -->
            <ng-container matColumnDef="fecha">
                <th mat-header-cell *matHeaderCellDef> Fecha </th>
                <td mat-cell *matCellDef="let element"> {{element.fecha | date:'shortDate'}} </td>
            </ng-container>

            <!-- Tipo Column -->
            <ng-container matColumnDef="tipo">
                <th mat-header-cell *matHeaderCellDef> Tipo </th>
                <td mat-cell *matCellDef="let element">
                    <span class="badge" [class.venta]="element.tipo === 'VENTA'"
                        [class.compra]="element.tipo === 'COMPRA'">
                        {{element.tipo}}
                    </span>
                </td>
            </ng-container>

            <!-- Entidad Column -->
            <ng-container matColumnDef="entidad">
                <th mat-header-cell *matHeaderCellDef> Cliente/Proveedor </th>
                <td mat-cell *matCellDef="let element"> {{element.entidad}} </td>
            </ng-container>

            <!-- Producto Column -->
            <ng-container matColumnDef="producto">
                <th mat-header-cell *matHeaderCellDef> Producto </th>
                <td mat-cell *matCellDef="let element"> {{element.prod_nombre}} </td>
            </ng-container>

            <!-- Cantidad Column -->
            <ng-container matColumnDef="cantidad">
                <th mat-header-cell *matHeaderCellDef> Cantidad </th>
                <td mat-cell *matCellDef="let element"> {{element.cantidad}} </td>
            </ng-container>

            <!-- Precio Column -->
            <ng-container matColumnDef="precio">
                <th mat-header-cell *matHeaderCellDef> Precio Unit. </th>
                <td mat-cell *matCellDef="let element"> {{element.precio | currency}} </td>
            </ng-container>

            <!-- Total Column -->
            <ng-container matColumnDef="total">
                <th mat-header-cell *matHeaderCellDef> Total </th>
                <td mat-cell *matCellDef="let element" [class.text-venta]="element.tipo === 'VENTA'"
                    [class.text-compra]="element.tipo === 'COMPRA'">
                    {{element.total | currency}}
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

            <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" colspan="7">No hay datos que coincidan con los filtros</td>
            </tr>
        </table>
    </div>

    <div class="modal-footer">
        <mat-paginator [length]="totalTransacciones" [pageSize]="pageSize" [pageIndex]="currentPage"
            [pageSizeOptions]="[50, 100, 200]" (page)="onPageChange($event)" showFirstLastButtons>
        </mat-paginator>

        <button mat-raised-button color="primary" (click)="exportarExcel()" [disabled]="isLoading">
            <mat-icon>file_download</mat-icon>
            Exportar a Excel
        </button>
    </div>
</div>